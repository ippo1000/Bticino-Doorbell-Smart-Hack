# Bticino Doorbell Hack
[![N|Solid](https://i.ibb.co/kDcyNtD/Powered-By.png)](ifcorp.it)

Hack Bticino 2-wire intercom
The aim is to transform a normal and cheap 2-wire intercom from Bticino into a totally smart intercom (Like Ring, Nest, Etc, and perhaps even much more advanced!)

The project is mainly divided into two parts:
The First allows you to make a PSTN telephone call by routing the audio of the BTicino 2-wire intercom system.
The second part instead consists in making a call when the intercom is ringed, or when it is activated by a Relay trigger (Wanting Sonoff, MQTT, ESP32, or similar)

## Telephone Call - Part1
The call is activated by the home automation system (Home Assistant) which only in the absence of people provides the trigger signal and detects the status of the call and the intercom. 
In homes equipped with optical fiber or VoIP telephony, the PSTN line is provided by the provider's modem, generally with very low latency.
[![Telephone and Doorbell IMG](https://i.ibb.co/br6zmGs/IMG-Cit-F-e-Phone.png)](https://amzn.to/33UsbeN)
The prototype is made up of various separate elements housed in a GW42004 type panel with dimensions 300X200X40.
Easily and with a little knowledge of the subject it is possible to compact everything and design a PCB.
If any of you have the imagination to do so, all changes or requests for changes are welcome.
![The Prototype](https://i.ibb.co/wyqVSGx/Cit-F-Photo.png)
Below is the description of the "Main" components I used: 
- One Bticino 2 wire internal unit [(PI 344232)](https://amzn.to/3ABGFMD)
- Vintage SIP Phone
- Key pressure simulator (telephone dialer) made by me with a PIC16F877A - PIC2
- Controller for the Bticino internal unit DIY from me
- Audio level controllers and separator adapters
- DTMF decoder with MT8870

# Modification of B-Ticino internal unit 
PI 344232 is the cheapest of the 2-wire line. It has 2 buttons, one to open the gate, the other configurable by the installer. 
In this case the second button is configured as "Door unit activation" by inserting configurator "9" in position "P". 
The Bticino configurator "9" is hacked, creating it with 2 resistors in parallel to achieve the exact value of 179 KOhm.
![Changes](https://i.ibb.co/Ntb8dkg/Mod-Posto-Interno-Cit.png)

In addition, the following must be implemented (You have to do them yourself): 
- Parallel connection between “PE activation” button and SPST relay
- Removal of the Hook diverter by returning the 6 contacts to a DPDT relay
- Connection of external gate opener button
- Connection of 2 600 Ohm audio transformers in parallel of the audio and microphone signals to electrically decouple the audio
- Controller (in this case with PIC16F648A) - PIC1

# Operation of the intercom controller
The intercom can be activated locally (green button) or by the automation system (Out 19 in my system, you can use a SonoffClean Contact MOD, Esp32, etc.). 
In both cases the DPDT relay simulates the lifting of the handset (OFF-HOOK) and the SPST relay activates the external unit (pressure of the auxiliary button configured with P = 9).
In case of local activation, the telephone call is not launched. This occurs in the case of activation from external automation (out 19 in my System) to which the status of "OFF-HOOK" is returned on input 64.
In this case the off-hook signal to the telephone is kept high for the entire time activation of the Intercom.
Bticino Intercom automatically cancels the call after one minute. The controller, counted 61 seconds from the first activation, activates the PE button again for a total of 2 minutes of conversation.
At the end of the 2 minutes, or if the red external button is pressed, the intercom returns to "ON-HOOK" and the call / off-hook signal to the telephone is closed. 
![RED BTN](https://i.ibb.co/VpwZqc8/BTNS.png)
# Modification Vintage SIP Telephone and Dialer with PIC16F877A
Here too, the double diverter activated when the handset is lifted is removed and replaced by a DPDT relay. The microphone and loudspeaker signals are picked up in parallel with the handset by means of 2 600 OHM audio transformers.
As for the dialer, the keyboard connected to the appropriate inputs of the integrated HT9212A dialer present in the phone is physically replaced. Each row is assigned a relay, as well as each column. 
The pressure of a button is simulated by the microcontroller which simultaneously activates the row relay and the column relay with a timing compatible with HT9212A.
When the call is activated (one input for each stored number), the dialer sends the telephone "off hook", performs the correct simulated key pressure sequence generating the DTMF call, and remains off-hook for as long as the signal call remains high.
When the call signal (generated by the intercom controller) drops, the call is interrupted and the phone goes back on-hook. 
If, during the call, the remote interlocutor closes the conversation, the phone remains off-hook until the 2 minutes communicated by the intercom controller have elapsed (also by pressing the red end call button).

# MT88 Tone Detector 
In a future development, the received audio is routed to an MT8870 tone decoder interfaced to the PIC16F877A to generate signals to home automation (gate opener, end-call, lights on, etc.)

![Pinout](https://i.ibb.co/hL3Sf8M/MT88-little.png)
# DC Current IN 
The power supply is stabilized by a 7805 (8-24V input). There is a 0.68F 5.5V supercapacitor in the combiner.

# Telegram and Home Assistant Integration
I don't use Home Assistant as my main system, but I only use it as a Dashboard, someday maybe I'll decide to make the leap.
I currently use my home system made by myself about 15 years ago with PICs and a basic and always expanded Visual Basic Application.
But a few months ago to play I decided to post all my sensors of my system on MQTT, and so also the intercom.
As you can see in this photo below thanks to HA and Telegram I managed to make this fantastic notification!
In case of DoorBell Ring (Taken from this "Box") an input of my system goes up (1) (you can use a normal Sonoff CC) and MQTT sends the status to HA, which sends a Telegram notification.
![HA Notify ](https://i.ibb.co/ZxP4HDG/Notify-Blur-Little.png)
Thanks to my ONVIF cameras, I will receive a SnapShot of who is at the door, and underneath I have buttons to interact with my home.

- The "Apri il Pedonale" button sends an input on MQTT which triggers a relay, which again, thanks to the box, opens the gate.
- The "Send Another Snap" button simply sends another picture of who is out
- The "Parla con Chi é fuori" button activates the call, if you press HA it sends the string on MQTT, and a Relay is activated, which starts the call to the person who requested it from Telegram.
- The button "Non fare nulla", does nothing :)

I also leave my HA Automation code on GitHub MAIN which does all of this.
Next implementation: Notification in case of Gate Opening / Closing after an intercom call.

# Concusions
This is a project that I started about 2 years ago, and every month I have always added something, up to this point, I have tried it for 2 months now and it has never been wrong, sometimes I have not used it for weeks, but it has always worked!
I have my own home system, but as a hobby I also use Home Assistant, and I can say that it is perfectly integrated.
As you can see in the previous section, with Telegram, I take full advantage of this box.
I know that it is very difficult to make by someone, or rather, that you can make it but perhaps with more modern components such as ARDUINO or SIP Client.
However, I wanted to share my project with you given the many requests.
For the more adventurous I leave the ProtonIDE .bas files in the GitHub for the pic, if anyone wants to try to replicate it.
In case of doubts / help or clarifications I am at your disposal in the GitHub issues or on Filippo.toni@ifcorp.it
Lang: Italian / English
